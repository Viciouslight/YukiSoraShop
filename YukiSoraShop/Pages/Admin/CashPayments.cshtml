@page
@model YukiSoraShop.Pages.Admin.CashPaymentsModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Xác nhận thanh toán tiền mặt";
    Layout = "~/Pages/Shared/_Layout.cshtml";
    var antiForgeryToken = Antiforgery.GetAndStoreTokens(HttpContext).RequestToken;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="fas fa-hand-holding-usd me-2"></i> Xác nhận thanh toán tiền mặt
    </h2>
    <a class="btn btn-outline-secondary" asp-page="/Admin/Dashboard">
        <i class="fas fa-arrow-left"></i> Về Dashboard
    </a>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Html.Raw(Model.StatusMessage)
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<input type="hidden" id="cash-antiforgery-token" value="@antiForgeryToken" />

<div id="cash-empty-alert" class="alert alert-info" style="display:@(Model.Orders.Count == 0 ? "block" : "none")">
    Hiện không có đơn hàng nào đang chờ xác nhận thanh toán tiền mặt.
</div>

<div id="cash-table-container" class="table-responsive shadow-sm rounded bg-white" style="display:@(Model.Orders.Count == 0 ? "none" : "block")">
    <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Đơn hàng</th>
                    <th scope="col">Khách hàng</th>
                    <th scope="col">Ngày tạo</th>
                    <th scope="col">Tổng tiền</th>
                    <th scope="col">Trạng thái thanh toán</th>
                    <th scope="col" class="text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody id="cash-table-body">
                @foreach (var order in Model.Orders)
                {
                    <tr id="cash-order-@order.OrderId" data-order-id="@order.OrderId">
                        <td>#@order.OrderId</td>
                        <td>
                            <strong data-role="customer-name">@order.CustomerName</strong><br />
                            <small class="text-muted" data-role="customer-email">@order.CustomerEmail</small>
                        </td>
                        <td data-role="created-at">@order.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                        <td><strong data-role="grand-total">@order.GrandTotal.ToString("N0") ₫</strong></td>
                        <td>
                            <span class="badge bg-warning text-dark" data-role="payment-status">@order.PaymentStatus</span>
                        </td>
                        <td class="text-end">
                            <form method="post" asp-page-handler="Confirm" class="d-inline">
                                <input type="hidden" name="orderId" value="@order.OrderId" />
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="fas fa-check-circle me-1"></i> Đã nhận tiền
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js" integrity="sha512-8w7PjJYG1ChcxrFAuo0xO+ogzAm8h1Hn0pVITNrW2N7DbStO2Qd6hw2yffA9H9n1tFoZTsvuCFbYo+aX6YTL/w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        (() => {
            const antiforgeryToken = document.getElementById("cash-antiforgery-token")?.value ?? "";
            const tableBody = document.getElementById("cash-table-body");
            const tableContainer = document.getElementById("cash-table-container");
            const emptyAlert = document.getElementById("cash-empty-alert");

            function formatCurrency(value) {
                return Number(value || 0).toLocaleString("vi-VN") + " ₫";
            }

            function toLocalDateTime(value) {
                if (!value) return "";
                const date = new Date(value);
                if (isNaN(date.getTime())) return value;
                return date.toLocaleString("vi-VN");
            }

            function toggleEmptyState() {
                const hasRows = tableBody?.children?.length > 0;
                if (tableContainer) tableContainer.style.display = hasRows ? "block" : "none";
                if (emptyAlert) emptyAlert.style.display = hasRows ? "none" : "block";
            }

            function renderCashRow(payload) {
                if (!tableBody) {
                    return;
                }
                const id = payload.orderId ?? payload.OrderId;
                if (!id) return;
                const existing = document.getElementById(`cash-order-${id}`);
                const row = existing ?? document.createElement("tr");
                row.id = `cash-order-${id}`;
                row.dataset.orderId = id;
                if (!existing) {
                    row.innerHTML = `
                        <td class="cash-order-id"></td>
                        <td>
                            <strong data-role="customer-name"></strong><br />
                            <small class="text-muted" data-role="customer-email"></small>
                        </td>
                        <td data-role="created-at"></td>
                        <td><strong data-role="grand-total"></strong></td>
                        <td><span class="badge bg-warning text-dark" data-role="payment-status"></span></td>
                        <td class="text-end">
                            <form method="post" action="?handler=Confirm" class="d-inline">
                                <input type="hidden" name="__RequestVerificationToken" value="${antiforgeryToken}" />
                                <input type="hidden" name="orderId" value="${id}" />
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="fas fa-check-circle me-1"></i> Đã nhận tiền
                                </button>
                            </form>
                        </td>`;
                    tableBody.prepend(row);
                }

                const idCell = row.querySelector(".cash-order-id");
                if (idCell) { idCell.textContent = `#${id}`; }
                const nameEl = row.querySelector('[data-role="customer-name"]');
                if (nameEl) { nameEl.textContent = payload.customerName ?? payload.CustomerName ?? `User #${payload.accountId ?? payload.AccountId ?? ""}`; }
                const emailEl = row.querySelector('[data-role="customer-email"]');
                if (emailEl) { emailEl.textContent = payload.customerEmail ?? payload.CustomerEmail ?? ""; }
                const createdAtEl = row.querySelector('[data-role="created-at"]');
                if (createdAtEl) { createdAtEl.textContent = payload.createdAtDisplay ?? toLocalDateTime(payload.createdAt ?? payload.CreatedAt); }
                const totalEl = row.querySelector('[data-role="grand-total"]');
                if (totalEl) { totalEl.textContent = formatCurrency(payload.grandTotal ?? payload.GrandTotal); }
                const statusEl = row.querySelector('[data-role="payment-status"]');
                if (statusEl) {
                    statusEl.textContent = payload.paymentStatus ?? payload.PaymentStatus ?? "Pending";
                    statusEl.classList.remove("bg-success", "bg-warning", "bg-secondary", "bg-danger", "text-dark");
                    const status = (payload.paymentStatus ?? payload.PaymentStatus ?? "").toString().toLowerCase();
                    if (status === "paid") {
                        statusEl.classList.add("bg-success");
                    } else if (status === "pending") {
                        statusEl.classList.add("bg-warning", "text-dark");
                    } else {
                        statusEl.classList.add("bg-secondary");
                    }
                }

                toggleEmptyState();
            }

            function removeCashRow(payload) {
                const id = payload?.orderId ?? payload?.OrderId;
                if (!id) return;
                const row = document.getElementById(`cash-order-${id}`);
                if (row?.parentElement) {
                    row.parentElement.removeChild(row);
                }
                toggleEmptyState();
            }

            function applyDashboardSummary(summary) {
                const map = {
                    totalUsersValue: summary?.totalUsers ?? summary?.TotalUsers,
                    totalProductsValue: summary?.totalProducts ?? summary?.TotalProducts,
                    totalOrdersValue: summary?.totalOrders ?? summary?.TotalOrders,
                    awaitingCashValue: summary?.awaitingCashOrders ?? summary?.AwaitingCashOrders,
                    totalRevenueValue: summary?.totalRevenue ?? summary?.TotalRevenue
                };

                Object.entries(map).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (!el || value === undefined || value === null) return;
                    if (id === "totalRevenueValue") {
                        el.textContent = Number(value).toLocaleString("vi-VN", { style: "currency", currency: "VND" });
                    } else {
                        el.textContent = value;
                    }
                });
            }

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/adminDashboard")
                .withAutomaticReconnect()
                .build();

            connection.on("DashboardSummaryUpdated", applyDashboardSummary);
            connection.on("CashOrderRemoved", removeCashRow);
            connection.on("CashOrderAdded", renderCashRow);

            toggleEmptyState();

            connection.start().catch(err => console.error("SignalR connection error:", err));
        })();
    </script>
}
