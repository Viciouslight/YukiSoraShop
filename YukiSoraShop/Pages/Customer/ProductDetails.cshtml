@page "{id:int}"
@model YukiSoraShop.Pages.Customer.ProductDetailsModel
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
}

<!-- Alerts -->
@await Html.PartialAsync("_Alerts")

<div class="container my-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="fw-bold display-6">@Model.Product.Name</h1>
        <p class="text-muted lead">@Model.Product.Category</p>
    </div>

    <div class="row g-5 align-items-start">
        <!-- Product Image -->
        <div class="col-md-5">
            <div class="card border-0 shadow-sm">
                <img src="@Model.Product.ImageUrl"
                     alt="@Model.Product.Name"
                     class="img-fluid rounded-4"
                     style="object-fit: cover; height: 420px;" />
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-7">
            <div class="card border-0 shadow-sm p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-@(Model.Product.IsAvailable ? "success" : "secondary") fs-6">
                        @(Model.Product.IsAvailable ? "Còn hàng" : "Hết hàng")
                    </span>
                    <h3 class="text-danger fw-bold mb-0">
                        @Model.Product.Price.ToString("N0") VNĐ
                    </h3>
                </div>

                <p class="text-secondary mb-4">@Model.Product.Description</p>

                <dl class="row small mb-4">
                    <dt class="col-sm-3">Danh mục:</dt>
                    <dd class="col-sm-9">@Model.Product.Category</dd>
                    <dt class="col-sm-3">Mã sản phẩm:</dt>
                    <dd class="col-sm-9">@Model.Product.Id</dd>
                </dl>

                <form method="post" asp-page-handler="AddToCart" class="d-grid gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Product.Id" />
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ hàng
                    </button>
                </form>
            </div>

            <!-- Alert messages -->
            @if (TempData["Success"] != null || TempData["Error"] != null)
            {
                <div class="mt-4">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <hr class="my-5" />

    <!-- Product Variants -->
    <section>
        <h4 class="fw-semibold mb-3">Chi tiết biến thể sản phẩm</h4>

        @if (Model.ProductDetails != null && Model.ProductDetails.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle shadow-sm">
                    <thead class="table-light">
                        <tr class="text-center">
                            <th>Màu sắc</th>
                            <th>Kích thước</th>
                            <th>Chất liệu</th>
                            <th>Xuất xứ</th>
                            <th>Mô tả chi tiết</th>
                            <th>Giá phụ</th>
                            <th>Ảnh</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detail in Model.ProductDetails)
                        {
                            <tr>
                                <td>@detail.Color</td>
                                <td>@detail.Size</td>
                                <td>@detail.Material</td>
                                <td>@detail.Origin</td>
                                <td>@detail.Description</td>
                                <td class="text-end text-danger fw-semibold">
                                    @((detail.AdditionalPrice ?? 0).ToString("N0")) VNĐ
                                </td>
                                <td class="text-center">
                                    <img src="@detail.ImageUrl"
                                         alt="Ảnh chi tiết"
                                         class="rounded-3"
                                         style="width: 60px; height: 60px; object-fit: cover;" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>Chưa có thông tin chi tiết cho sản phẩm này.
            </div>
        }
    </section>
</div>
@section Scripts {
    <script>
        // Dữ liệu biến thể từ backend (ProductDetails)
        const productVariants = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProductDetails));

        const colorSelect = document.getElementById('color');
        const sizeRadios = document.querySelectorAll('input[name="size"]');
        const addToCartBtn = document.querySelector('button[type="submit"]');
        const selectedDetailInput = document.getElementById('selectedDetailId');

        // 🧩 Hàm lọc size theo màu hiện tại
        function filterSizes() {
            const selectedColor = colorSelect.value;
            const validSizes = productVariants
                .filter(v => v.Color === selectedColor)
                .map(v => v.Size);

            sizeRadios.forEach(radio => {
                if (validSizes.includes(radio.value)) {
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                } else {
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.4';
                    radio.checked = false;
                }
            });

            updateSelectedDetailId();
        }

        // 🧩 Hàm cập nhật ID biến thể vào hidden input
        function updateSelectedDetailId() {
            const selectedColor = colorSelect.value;
            const selectedSize = document.querySelector('input[name="size"]:checked')?.value;

            const variant = productVariants.find(v =>
                v.Color === selectedColor && v.Size === selectedSize
            );

            if (variant) {
                selectedDetailInput.value = variant.Id; // ✅ đúng ID biến thể
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = "Thêm vào giỏ hàng";
            } else {
                selectedDetailInput.value = "";
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = "Vui lòng chọn màu & size";
            }
        }

        // 🧩 Gắn sự kiện động
        colorSelect.addEventListener('change', filterSizes);
        sizeRadios.forEach(radio => radio.addEventListener('change', updateSelectedDetailId));
        document.addEventListener('DOMContentLoaded', () => {
            filterSizes(); // khởi tạo lần đầu
            addToCartBtn.disabled = true; // chặn click sớm
        });

        // 🧩 Chặn submit nếu chưa có biến thể hợp lệ
        document.querySelector('form').addEventListener('submit', e => {
            if (!selectedDetailInput.value) {
                e.preventDefault();
                alert("Vui lòng chọn màu sắc và kích thước trước khi thêm vào giỏ hàng!");
            }
        });
    </script>
}


