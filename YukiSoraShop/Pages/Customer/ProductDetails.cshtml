@page "{id:int}"
@model YukiSoraShop.Pages.Customer.ProductDetailsModel
@{
    ViewData["Title"] = Model.Product?.Name ?? "Chi tiết sản phẩm";
    var isAdminOrStaff = User.IsInRole("Administrator") || User.IsInRole("Moderator");
}

<div class="container my-5">
    @if (isAdminOrStaff)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Lưu ý:</strong> Tài khoản quản trị/nhân viên không thể thêm sản phẩm vào giỏ hàng.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-5">
        <!-- Ảnh sản phẩm -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm p-3">
                <img src="@Model.Product.ImageUrl" alt="@Model.Product.Name"
                     class="img-fluid rounded-4" style="object-fit: cover; height: 420px;">
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
                @foreach (var detail in Model.Product.ProductDetails.Take(4))
                {
                    <img src="@detail.ImageUrl" class="rounded-3 border"
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                         onclick="selectVariant('@detail.Id', '@detail.ImageUrl', '@detail.AdditionalPrice')" />
                }
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-lg-7">
            <h2 class="fw-bold">@Model.Product.Name</h2>
            <p class="text-muted">@Model.Product.Category</p>
            <h3 id="product-price" class="text-danger fw-bold mb-3">
                @Model.Product.Price.ToString("N0") VNĐ
            </h3>

            <p class="text-secondary">@Model.Product.Description</p>

            <dl class="row small mb-4">
                <dt class="col-sm-4">Danh mục:</dt>
                <dd class="col-sm-8">@Model.Product.Category</dd>
                <dt class="col-sm-4">Mã sản phẩm:</dt>
                <dd class="col-sm-8">@Model.Product.Id</dd>
            </dl>

            @if (Model.Product.ProductDetails.Any())
            {
                <div class="mb-3">
                    <label class="fw-semibold">Chọn biến thể:</label>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        @foreach (var detail in Model.Product.ProductDetails)
                        {
                            <button type="button" class="btn btn-outline-primary btn-sm variant-btn"
                                    data-id="@detail.Id"
                                    data-extra="@detail.AdditionalPrice"
                                    onclick="selectVariant('@detail.Id', '@detail.ImageUrl', '@detail.AdditionalPrice')">
                                @detail.Color @if(!string.IsNullOrWhiteSpace(detail.Size)){<span>(@detail.Size)</span>}
                            </button>
                        }
                    </div>
                </div>
            }

            @if (isAdminOrStaff)
            {
                <button type="button" class="btn btn-lg btn-secondary w-100" disabled title="Tài khoản quản trị/nhân viên không thể mua hàng">
                    <i class="fas fa-ban me-2"></i>Không thể thêm vào giỏ hàng
                </button>
            }
            else
            {
                <form method="post" asp-page-handler="AddToCart" class="mt-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Product.Id" />
                    <input type="hidden" id="selectedDetailId" name="productDetailId" value="0" />

                    <button type="submit" id="addToCartBtn" class="btn btn-lg btn-primary w-100" disabled>
                        <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ hàng
                    </button>
                </form>
            }
        </div>
    </div>

    <hr class="my-5" />

    <!-- Thông số kỹ thuật -->
    <section>
        <h4 class="fw-semibold mb-3">Thông số kỹ thuật</h4>
        <table class="table table-bordered table-striped">
            <tbody>
                @if (Model.Product.ProductDetails.Any())
                {
                    var d = Model.Product.ProductDetails.First();
                    <tr><th>Màu sắc</th><td>@d.Color</td></tr>
                    <tr><th>Kích thước</th><td>@d.Size</td></tr>
                    <tr><th>Chất liệu</th><td>@d.Material</td></tr>
                    <tr><th>Xuất xứ</th><td>@d.Origin</td></tr>
                }
            </tbody>
        </table>
    </section>

    <!-- Mô tả chi tiết -->
    <section class="mt-5">
        <h4 class="fw-semibold mb-3">Mô tả chi tiết</h4>
        <p>@Model.Product.ProductDetails.FirstOrDefault()?.Description</p>
    </section>
</div>

@section Scripts {
<script>
    const addToCartBtn = document.getElementById('addToCartBtn');
    const selectedDetailInput = document.getElementById('selectedDetailId');
    const variantBtns = document.querySelectorAll('.variant-btn');
    const priceEl = document.getElementById('product-price');
    const basePrice = parseFloat("@Model.Product.Price");
    const hasVariants = @(Model.Product.ProductDetails.Any() ? "true" : "false");

    // If no variants, enable button immediately
    if (!hasVariants && addToCartBtn) {
        addToCartBtn.disabled = false;
    }

    function selectVariant(id, imgUrl, extraPrice) {
        if (!addToCartBtn) return;
        
        selectedDetailInput.value = id;
        addToCartBtn.disabled = false;

        variantBtns.forEach(btn => btn.classList.remove('active'));
        const btn = document.querySelector(`.variant-btn[data-id='${id}']`);
        if (btn) btn.classList.add('active');

        // cập nhật ảnh chính
        const mainImg = document.querySelector(".card img");
        if (mainImg) mainImg.src = imgUrl;

        // cập nhật giá
        const newPrice = basePrice + parseFloat(extraPrice || 0);
        priceEl.innerText = newPrice.toLocaleString('vi-VN') + " VNĐ";
    }
</script>
}
